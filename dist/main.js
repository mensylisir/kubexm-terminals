(function(a,e){typeof exports=="object"&&typeof module<"u"?e(require("@kinvolk/headlamp-plugin/lib"),require("react/jsx-runtime"),require("@mui/material"),require("react")):typeof define=="function"&&define.amd?define(["@kinvolk/headlamp-plugin/lib","react/jsx-runtime","@mui/material","react"],e):(a=typeof globalThis<"u"?globalThis:a||self,e(a.pluginLib,a.pluginLib.ReactJSX,a.pluginLib.MuiMaterial,a.pluginLib.React))})(this,function(a,e,s,O){"use strict";const o=(n=>n&&typeof n=="object"&&"default"in n?n:{default:n})(O),$={apiVersion:"v1",kind:"Namespace",metadata:{name:"kubexm-terminals"}},L={apiVersion:"v1",kind:"ServiceAccount",metadata:{name:"ops-ui-admin-sa",namespace:"kubexm-terminals"}},B={apiVersion:"rbac.authorization.k8s.io/v1",kind:"ClusterRoleBinding",metadata:{name:"ops-ui-admin-binding"},subjects:[{kind:"ServiceAccount",name:"ops-ui-admin-sa",namespace:"kubexm-terminals"}],roleRef:{kind:"ClusterRole",name:"cluster-admin",apiGroup:"rbac.authorization.k8s.io"}};function E(n){return{apiVersion:"apps/v1",kind:"DaemonSet",metadata:{name:"node-shell-ds",namespace:"kubexm-terminals",labels:{app:"node-shell"}},spec:{selector:{matchLabels:{app:"node-shell"}},template:{metadata:{labels:{app:"node-shell"}},spec:{serviceAccountName:"ops-ui-admin-sa",tolerations:[{operator:"Exists"}],hostNetwork:!0,hostPID:!0,volumes:[{name:"host-root",hostPath:{path:"/"}}],containers:[{name:"node-shell-container",image:n,command:["/bin/sh","-c"],args:["exec /usr/bin/ttyd --writable -p 7681 /usr/bin/nsenter --target 1 --mount --uts --ipc --net --pid /bin/bash"],ports:[{name:"node-shell",containerPort:7681,hostPort:7681}],volumeMounts:[{name:"host-root",mountPath:"/host"}],securityContext:{privileged:!0}}]}}}}}function j(n){return{apiVersion:"apps/v1",kind:"Deployment",metadata:{name:"kubectl-shell-deployment",namespace:"kubexm-terminals",labels:{app:"kubectl-shell"}},spec:{replicas:1,selector:{matchLabels:{app:"kubectl-shell"}},template:{metadata:{labels:{app:"kubectl-shell"}},spec:{serviceAccountName:"ops-ui-admin-sa",hostname:"kubectl-shell",tolerations:[{key:"node-role.kubernetes.io/master",effect:"NoSchedule"},{key:"node-role.kubernetes.io/control-plane",effect:"NoSchedule"}],containers:[{name:"kubectl-shell-container",image:n,command:["/usr/bin/ttyd"],args:["--writable","-p","7682","/bin/bash"],ports:[{name:"kubectl-shell",containerPort:7682}]}]}}}}}const q={apiVersion:"v1",kind:"Service",metadata:{name:"kubectl-shell-svc",namespace:"kubexm-terminals"},spec:{type:"NodePort",selector:{app:"kubectl-shell"},ports:[{protocol:"TCP",port:80,targetPort:7682,nodePort:30082}]}},p="kubexm-terminals",D=7681,_=30082;function J(n){var b;const h=((b=n.status)==null?void 0:b.addresses)||[];let i=null,c=null;for(const r of h)r.type==="ExternalIP"&&(c=r.address),r.type==="InternalIP"&&(i=r.address);return c||i}function V(){const[n,h]=o.default.useState(null),[i,c]=o.default.useState(!0),[b,r]=o.default.useState(null),[d,z]=o.default.useState(null),[W,k]=o.default.useState(!0),[g,K]=o.default.useState("registry.dev.rdev.tech:18093/headlamp/universal-toolkit:1.0"),[m,v]=o.default.useState(0),[f,U]=o.default.useState(10),y=o.default.useCallback(async()=>{c(!0),r(null);try{await a.ApiProxy.request(`/apis/apps/v1/namespaces/${p}/deployments/kubectl-shell-deployment`),h(!0)}catch(t){t.status===404||r(`检查资源失败: ${t.message}`),h(!1)}finally{c(!1)}},[]),x=o.default.useCallback(()=>{k(!0),a.ApiProxy.request("/api/v1/nodes").then(t=>z(t.items||[])).catch(t=>r(`加载节点列表失败: ${t.message}`)).finally(()=>k(!1))},[]);o.default.useEffect(()=>{y()},[y]),o.default.useEffect(()=>{n&&x()},[n,x]);const H=async()=>{c(!0),r(null);try{await a.ApiProxy.request("/api/v1/namespaces",{method:"POST",body:JSON.stringify($),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await a.ApiProxy.request(`/api/v1/namespaces/${p}/serviceaccounts`,{method:"POST",body:JSON.stringify(L),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await a.ApiProxy.request("/apis/rbac.authorization.k8s.io/v1/clusterrolebindings",{method:"POST",body:JSON.stringify(B),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await a.ApiProxy.request(`/apis/apps/v1/namespaces/${p}/daemonsets`,{method:"POST",body:JSON.stringify(E(g)),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await a.ApiProxy.request(`/apis/apps/v1/namespaces/${p}/deployments`,{method:"POST",body:JSON.stringify(j(g)),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await a.ApiProxy.request(`/api/v1/namespaces/${p}/services`,{method:"POST",body:JSON.stringify(q),headers:{"Content-Type":"application/json"}}).catch(t=>{if(t.status!==409)throw t}),await y()}catch(t){r(`安装失败: ${t.message}`)}finally{c(!1)}},M=(t,l)=>{v(l)},F=t=>{U(parseInt(t.target.value,10)),v(0)};if(i&&n===null)return e.jsxs(s.Paper,{sx:{p:2,m:2},children:[e.jsx(s.CircularProgress,{})," ",e.jsx(s.Typography,{sx:{ml:2,display:"inline-block",verticalAlign:"middle"},children:"正在检查终端环境..."})]});if(n===!1)return e.jsxs(s.Paper,{sx:{m:2,p:3},children:[e.jsx(s.Typography,{variant:"h4",gutterBottom:!0,children:"Kubexm控制台设置"}),e.jsx(s.Alert,{severity:"info",sx:{mb:2},children:"看起来是您第一次使用本插件，需要先在集群中安装所需的后端服务。"}),e.jsx(s.TextField,{label:"终端镜像地址",fullWidth:!0,variant:"outlined",size:"small",value:g,onChange:t=>K(t.target.value),sx:{mb:2}}),e.jsx(s.Button,{variant:"contained",onClick:H,disabled:i,startIcon:i&&e.jsx(s.CircularProgress,{size:20,color:"inherit"}),children:i?"正在安装...":"安装/修复后端服务"}),b&&e.jsx(s.Alert,{severity:"error",sx:{mt:2},children:b})]});const G=`http://${window.location.hostname}:${_}`,T=t=>window.open(t,"_blank","noopener,noreferrer");return e.jsxs(s.Paper,{sx:{m:2,p:3},children:[e.jsx(s.Typography,{variant:"h4",gutterBottom:!0,children:"Kubexm控制台"}),e.jsxs(s.Box,{sx:{mb:4,p:2,border:"1px solid",borderColor:"divider",borderRadius:1},children:[e.jsx(s.Typography,{variant:"h6",gutterBottom:!0,children:"集群管理控制台(kubectl)"}),e.jsx(s.Button,{variant:"contained",color:"primary",onClick:()=>T(G),children:"打开集群管理控制台"})]}),e.jsxs(s.Box,{children:[e.jsx(s.Typography,{variant:"h6",gutterBottom:!0,children:"节点控制台(root shell)"}),W?e.jsx(s.CircularProgress,{}):e.jsxs(s.Paper,{component:s.Paper,variant:"outlined",children:[e.jsx(s.TableContainer,{children:e.jsxs(s.Table,{stickyHeader:!0,children:[e.jsx(s.TableHead,{children:e.jsxs(s.TableRow,{children:[e.jsx(s.TableCell,{sx:{fontWeight:"bold"},children:"节点名称"}),e.jsx(s.TableCell,{sx:{fontWeight:"bold"},children:"IP地址"}),e.jsx(s.TableCell,{sx:{fontWeight:"bold"},children:"操作系统"}),e.jsx(s.TableCell,{sx:{fontWeight:"bold"},children:"Kubelet版本"}),e.jsx(s.TableCell,{align:"right",sx:{fontWeight:"bold"}})]})}),e.jsx(s.TableBody,{children:d==null?void 0:d.slice(m*f,m*f+f).map(t=>{var C,S,w,N,I,A;const l=J(t),P=l?`http://${l}:${D}`:"";return e.jsxs(s.TableRow,{hover:!0,children:[e.jsx(s.TableCell,{children:(C=t.metadata)==null?void 0:C.name}),e.jsx(s.TableCell,{children:l||"Not Found"}),e.jsx(s.TableCell,{children:(w=(S=t.status)==null?void 0:S.nodeInfo)==null?void 0:w.osImage}),e.jsx(s.TableCell,{children:(I=(N=t.status)==null?void 0:N.nodeInfo)==null?void 0:I.kubeletVersion}),e.jsx(s.TableCell,{align:"right",children:e.jsx(s.Button,{variant:"outlined",size:"small",disabled:!l,onClick:()=>T(P),children:"控制台"})})]},(A=t.metadata)==null?void 0:A.uid)})})]})}),e.jsx(s.TablePagination,{rowsPerPageOptions:[5,10,25,{label:"全部",value:-1}],component:"div",count:(d==null?void 0:d.length)||0,rowsPerPage:f,page:m,onPageChange:M,onRowsPerPageChange:F,labelRowsPerPage:"每页行数:",labelDisplayedRows:({from:t,to:l,count:P})=>`第 ${t} - ${l} 行，共 ${P} 行`})]})]})]})}const u="kubexm-terminals";a.registerSidebarEntry({parent:null,name:u,label:"控制台",url:`/${u}`,icon:"mdi:console-network-outline"}),a.registerRoute({path:`/${u}`,sidebar:u,name:u,exact:!0,component:V})});
